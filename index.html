<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>æ—¥ãƒ—æ–°ä¸–ç•Œ æ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼</title>

<style>
  :root{
    --bg:#f6f6f6;
    --card:#ffffff;
    --line:#e6e6e6;
    --text:#111;
    --muted:#666;
    --shadow: 0 4px 14px rgba(0,0,0,.06);
    --radius:14px;

    /* â˜…é’å›ºå®š */
    --blue:#0080ff;

    /* â˜…JSã§è‡ªå‹•èª¿æ•´ï¼ˆå¹…/é«˜ã•ã©ã£ã¡ã‚‚è¦‹ã¦ã€Œå¿…ãšåã¾ã‚‹ã€ï¼‰ */
    --slot: 82px;
    --gap:  16px;
  }

  *{ box-sizing:border-box; }

  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }
  .topbar{
    padding: 12px 12px 10px;
    max-width: 980px;
    margin: 0 auto;
  }
  h1{margin:0;font-size:20px;line-height:1.2}
  .by{margin:6px 0 0;font-size:13px;color:var(--muted)}

  main{max-width:980px;margin:0 auto;padding:12px;}

  .card{
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* ç”»é¢è¡¨ç¤ºç”¨ãƒãƒŠãƒ¼ */
  .banner{
    height: 110px;
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,120,200,.30), transparent 40%),
      radial-gradient(circle at 80% 40%, rgba(120,160,255,.28), transparent 45%),
      linear-gradient(135deg, #ffe7f4, #eef3ff);
  }
  .banner.hasImage{
    background-size: cover;
    background-position: center;
  }
  .banner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .bannerTitle{
    position:relative;
    font-weight: 900;
    letter-spacing: .06em;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(255,255,255,.9);
    font-size: 14px;
  }

  /* ãƒ”ãƒ©ãƒŸãƒƒãƒ‰ */
  .pyramidWrap{
    padding: 12px 14px 8px;

    /* â˜…èƒŒæ™¯ç”»åƒï¼ˆãƒ”ãƒ©ãƒŸãƒƒãƒ‰éƒ¨åˆ†ï¼‰ */
    background-image: url("https://i.imgur.com/lFGbXfI.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .pyramid{
    display:flex;
    flex-direction:column;
    gap: var(--gap);
    padding: 8px 0 6px;
    align-items:center;
  }
  .row{
    display:flex;
    justify-content:center;
    gap: var(--gap);
    width:100%;
  }

  .slot{
    width: var(--slot);
    text-align:center;
  }

  /* â˜…æ è‰²ã‚’ #0080ff ã« */
  .avatar{
    width: var(--slot);
    height: var(--slot);
    border-radius:999px;
    border: 5px solid var(--blue);
    background:#fff;
    overflow: visible;
    box-shadow: 0 8px 18px rgba(0,0,0,.10);
    margin: 0 auto;
    position:relative;
    z-index: 1;
  }

  .avatar img{
    width:100%;
    height:100%;
    border-radius:999px;
    object-fit: cover;
    object-position: 50% 35%;
    display:block;
  }

  .rank{
    position:absolute;
    left:50%;
    bottom:-12px;
    transform: translateX(-50%);
    background: var(--blue);
    color:#fff;
    border-radius:999px;
    font-weight:900;
    font-size: 9px;
    padding: 6px 8px;
    border: none;
    line-height:1;
    min-width: 2.0em;
    text-align:center;

    z-index: 9999;
    box-shadow: 0 6px 14px rgba(0,0,0,.18);
    pointer-events:none;
  }

  .name{
    margin-top: 14px;
    font-size: 12px;
    font-weight: 900;
    line-height: 1.1;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }

  .empty .avatar{
    opacity:.16;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 34px;
    font-weight: 900;
    color:#555;
  }
  .empty .rank{display:none;}
  .empty .name{display:none;}

  .reorder{
    display:none;
    gap:10px;
    justify-content:center;
    margin-top: 8px;
  }
  body.reorder-on .reorder{ display:flex; }
  .reorder button{
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 16px;
    line-height: 1;
  }

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding: 10px 10px 12px;
    border-top: 1px solid #f1f1f1;
    background:#fff;
  }
  button{
    padding: 11px 12px;
    border-radius: 12px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 14px;
  }
  button:active{transform:scale(.98)}
  .primary{border-color:#cfe2ff;}
  .danger{border-color:#ffd6d6;}
  .mode{border-color:#e7e7e7;}

  .listCard{
    margin-top: 12px;
    padding: 10px;
    background:#fff;
    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  .searchRow{
    display:flex;
    gap:10px;
    align-items:center;
    margin-bottom: 10px;
  }
  .search{
    flex:1;
    display:flex;
    align-items:center;
    border:1px solid #ddd;
    border-radius: 12px;
    padding: 10px 12px;
    background:#fff;
  }
  .search input{
    border:none;
    outline:none;
    width:100%;
    font-size: 15px;
    background:transparent;
  }

  /* ä¸€è¦§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é ˜åŸŸï¼ˆèƒŒæ™¯ç”»åƒï¼‰ */
  #membersWrap{
    max-height: 52vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-top:1px solid #f1f1f1;
    padding-top: 10px;

    background-image: url("https://i.imgur.com/eJnRfv3.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }

  /* =========================
     â˜… 2åˆ—ã‚«ãƒ¼ãƒ‰
     ========================= */
  #members{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap: 12px;
    padding: 2px;
  }

  .memberCard{
    position: relative;
    border: 1px solid #ededed;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 6px 14px rgba(0,0,0,.06);
    overflow: hidden;
    cursor: pointer;
    user-select: none;
    min-height: 170px;
  }
  .memberCard:active{ transform: scale(.995); }

  .memberPhoto{
    width: 100%;
    height: 108px;
    background: #f5f5f5;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }
  .memberPhoto img{
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: 50% 20%;
    display:block;
  }

  .memberInfo{
    padding: 10px 10px 12px;
  }
  .memberName{
    font-size: 14px;
    font-weight: 900;
    line-height: 1.2;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .memberSub{
    margin-top: 4px;
    font-size: 12px;
    color: var(--muted);
    line-height: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  /* profile ãƒãƒƒã‚¸ï¼ˆå³ä¸Šï¼‰ */
  .profileLink{
    position:absolute;
    right: 8px;
    top: 8px;
    padding: 6px 10px;
    border-radius: 999px;
    font-size: 12px;
    font-weight: 900;
    text-decoration: none;
    color: var(--blue);
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(0,128,255,.20);
    box-shadow: 0 6px 14px rgba(0,0,0,.08);
  }
  .profileLink:active{ transform: scale(.98); }

  /* é¸æŠæ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã¯æŠ¼ã›ãªã„ï¼ˆ2å›é¸ã¹ãªã„ï¼‰ */
  .memberCard.selected{
    opacity: .35;
    filter: grayscale(1);
    pointer-events: none;
  }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(0,0,0,.78);
    color:#fff;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    display:none;
    z-index:999;
  }

  /* ===== ä¿å­˜å°‚ç”¨ã‚¨ãƒªã‚¢ï¼ˆ1004Ã—1040å›ºå®šï¼‰ ===== */
  #exportArea{
    position: fixed;
    left: -10000px;
    top: 0;
    width: 1004px;
    height: 1040px;
    background: #ffffff;
    overflow: hidden;
  }
  #exportInner{
    width: 1004px;
    height: 1040px;
    position: relative;
    background:#fff;
    overflow:hidden;

    background-image: url("https://i.imgur.com/lFGbXfI.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .exportBanner{
    height: 150px;
    background-size: cover;
    background-position: center;
    position:relative;
  }
  .exportBanner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .exportTitlePill{
    position:absolute;
    left:50%;
    top: 50%;
    transform: translate(-50%,-50%);
    font-weight: 900;
    letter-spacing: .06em;
    padding: 12px 20px;
    border-radius: 999px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(255,255,255,.92);
    font-size: 20px;
    color:#111;
    white-space: nowrap;
  }
  .exportBody{
    padding: 22px 56px 100px;
  }
  .exportPyramid{
    display:flex;
    flex-direction:column;
    gap: 26px;
    margin-top: 10px;
  }
  .exportRow{
    display:flex;
    justify-content:center;
    gap: 44px;
  }
  .exportSlot{
    width: 130px;
    text-align:center;
  }

  .exportAvatar{
    width:130px;height:130px;border-radius:999px;
    border: 8px solid var(--blue);
    overflow: visible;
    background:#fff;
    margin: 0 auto;
    box-shadow: 0 10px 22px rgba(0,0,0,.10);
    position:relative;
    z-index:1;
  }

  .exportPhoto{
    width:100%;
    height:100%;
    border-radius:999px;
    background-size: cover;
    background-position: 50% 35%;
    background-repeat: no-repeat;
  }

  .exportRank{
    position:absolute;
    left:50%;
    bottom:-14px;
    transform: translateX(-50%);
    background: var(--blue);
    color:#fff;
    border-radius:999px;
    font-weight:900;
    font-size: 12px;
    padding: 7px 10px;
    border:none;
    line-height:1;
    min-width: 2.2em;
    text-align:center;
    z-index: 9999;
    box-shadow: 0 8px 16px rgba(0,0,0,.18);
    pointer-events:none;
  }

  .exportName{
    margin-top: 18px;
    font-size: 16px;
    font-weight: 900;
    line-height: 1.15;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .exportEmpty{
    opacity:.14;
    filter: grayscale(1);
  }
  .exportEmpty .exportAvatar{
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 52px;
    font-weight: 900;
    color:#666;
  }
  .exportEmpty .exportRank{display:none;}
  .exportEmpty .exportName{display:none;}

  /* â˜…ä¿å­˜ã—ãŸç”»åƒã®å·¦ä¸‹ã« created by */
  .exportFooter{
    position:absolute;
    left: 24px;
    bottom: 18px;
    font-size: 16px;
    color:#666;
    z-index: 50;
  }

  /* =========================
     â˜… åˆè¨€è‘‰ãƒ­ãƒƒã‚¯UI + è§£é™¤æ¼”å‡º
     ========================= */
  body.locked{
    overflow: hidden;
    touch-action: none;
  }

  #lockOverlay{
    position: fixed;
    inset: 0;
    z-index: 99999;
    display: none;
    align-items: center;
    justify-content: center;
    padding: 18px;
    background: rgba(0,0,0,.52);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  #lockOverlay.show{ display:flex; }

  .lockCard{
    width: min(460px, 100%);
    border-radius: 18px;
    background: rgba(255,255,255,.92);
    border: 1px solid rgba(255,255,255,.60);
    box-shadow: 0 18px 50px rgba(0,0,0,.22);
    overflow: hidden;
  }
  .lockHead{
    padding: 14px 14px 10px;
    border-bottom: 1px solid rgba(0,0,0,.06);
    background:
      radial-gradient(circle at 20% 30%, rgba(255,120,200,.24), transparent 45%),
      radial-gradient(circle at 80% 40%, rgba(120,160,255,.22), transparent 50%),
      linear-gradient(135deg, rgba(255,255,255,.92), rgba(245,248,255,.92));
  }
  .lockTitle{
    margin:0;
    font-weight: 1000;
    letter-spacing: .04em;
    font-size: 16px;
  }
  .lockNote{
    margin: 8px 0 0;
    font-size: 12px;
    color: #555;
    font-weight: 700;
  }

  .lockBody{
    padding: 14px;
  }
  .lockLabel{
    margin: 0 0 8px;
    font-size: 13px;
    font-weight: 900;
    color:#222;
  }
  .lockInputRow{
    display:flex;
    gap: 10px;
    align-items: center;
  }
  #passInput{
    flex:1;
    padding: 12px 12px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.14);
    outline: none;
    font-size: 16px;
    background: rgba(255,255,255,.92);
  }
  #unlockBtn{
    padding: 12px 14px;
    border-radius: 12px;
    border: 1px solid rgba(0,0,0,.14);
    background: #fff;
    font-weight: 900;
  }
  #unlockBtn:active{ transform: scale(.98); }

  .lockHint{
    margin: 12px 0 0;
    font-size: 13px;
    font-weight: 800;
    color:#333;
  }
  .tiktokBtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    margin-top: 10px;
    padding: 12px 14px;
    border-radius: 14px;
    background: #111;
    color: #fff;
    text-decoration: none;
    font-weight: 1000;
    letter-spacing: .02em;
  }
  .tiktokBtn:active{ transform: scale(.98); }

  .lockErr{
    margin-top: 10px;
    font-size: 12px;
    font-weight: 900;
    color: #d40000;
    display:none;
  }
  .lockErr.show{ display:block; }

  /* è§£é™¤æ¼”å‡ºï¼ˆæš—è»¢â†’æ–‡å­—â†’ãµã‚ã£ã¨æ¶ˆãˆã‚‹ï¼‰ */
  #unlockFx{
    position: fixed;
    inset: 0;
    z-index: 100000;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,.78);
  }
  #unlockFx.show{ display:flex; }

  .fxText{
    font-weight: 1000;
    letter-spacing: .14em;
    color: rgba(255,255,255,.95);
    font-size: 22px;
    padding: 14px 18px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.28);
    background: rgba(255,255,255,.06);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    animation: fxPop 1900ms ease forwards;
  }
  @keyframes fxPop{
    0%   { opacity: 0; transform: translateY(10px) scale(.96); filter: blur(6px); }
    45%  { opacity: 1; transform: translateY(0) scale(1.00); filter: blur(0); }
    100% { opacity: 0; transform: translateY(-6px) scale(1.02); filter: blur(4px); }
  }

  /* æœ¬ä½“ãŒã€Œãµã‚ã£ã¨é–‹ãã€ */
  #app{
    opacity: 1;
    transform: none;
    filter: none;
    transition: opacity 420ms ease, transform 420ms ease, filter 420ms ease;
  }
  body.locked #app{
    opacity: 0;
    transform: translateY(10px) scale(.99);
    filter: blur(6px);
    pointer-events: none;
    user-select: none;
  }
</style>
</head>

<body>
<!-- â˜…åˆè¨€è‘‰ãƒ­ãƒƒã‚¯ -->
<div id="lockOverlay" aria-hidden="false">
  <div class="lockCard" role="dialog" aria-modal="true">
    <div class="lockHead">
      <h2 class="lockTitle">æ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½¿ã†ã«ã¯åˆè¨€è‘‰ãŒå¿…è¦ã§ã™</h2>
      <p class="lockNote">â€»åˆè¨€è‘‰ã¯å®šæœŸçš„ã«æ›´æ–°ã•ã‚Œã¾ã™</p>
    </div>
    <div class="lockBody">
      <p class="lockLabel">åˆè¨€è‘‰ã‚’å…¥åŠ›</p>
      <div class="lockInputRow">
        <input id="passInput" type="text" inputmode="text" autocomplete="off" autocapitalize="none" spellcheck="false" placeholder="åˆè¨€è‘‰ã‚’å…¥åŠ›" />
        <button id="unlockBtn" type="button">è§£é™¤</button>
      </div>
      <div id="passErr" class="lockErr">åˆè¨€è‘‰ãŒé•ã„ã¾ã™</div>

      <div class="lockHint">æœ€æ–°å‹•ç”»ã‹ã‚‰åˆè¨€è‘‰ã‚’ç¢ºèªã—ã¦ã­ï¼</div>
      <a class="tiktokBtn" href="https://www.tiktok.com/@12agassi" target="_blank" rel="noopener noreferrer">TikTokã¸ç§»å‹•</a>
    </div>
  </div>
</div>

<!-- â˜…è§£é™¤æ¼”å‡º -->
<div id="unlockFx" aria-hidden="true">
  <div class="fxText">PRODUCE101JAPAN</div>
</div>

<header>
  <div class="topbar">
    <h1>æ—¥ãƒ—æ–°ä¸–ç•Œ æ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼</h1>
    <p class="by">created by @12agassi</p>
  </div>
</header>

<!-- â˜…ã‚¢ãƒ—ãƒªæœ¬ä½“ -->
<div id="app">
  <main>
    <div class="card" id="pyramidCard">
      <div id="banner" class="banner">
        <div class="bannerTitle">AUDITION PICK â€¢ YOUR TOP 11</div>
      </div>

      <div class="pyramidWrap" id="pyramidWrap">
        <div class="pyramid" id="pyramid"></div>
      </div>

      <div class="actions">
        <button class="primary" onclick="saveImage()">ç”»åƒã¨ã—ã¦ä¿å­˜</button>
        <button onclick="undo()">1äººæˆ»ã™</button>
        <button class="danger" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
        <button class="mode" id="reorderBtn" onclick="toggleReorder()">ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šOFF</button>
      </div>
    </div>

    <div class="listCard">
      <div class="searchRow">
        <div class="search">
          <input id="search" type="text" placeholder="Search" oninput="drawMembers()" />
        </div>
        <!-- â˜…ç·´ç¿’ç”Ÿ/ç·´ç¿’ç”Ÿå€™è£œã®åˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
        <button class="mode" id="toggleListBtn" type="button" onclick="toggleCandidates(event)">ç·´ç¿’ç”Ÿå€™è£œ</button>
      </div>
      <div id="membersWrap">
        <div id="members"></div>
      </div>
    </div>
  </main>
</div>

<div class="toast" id="toast">ç”»åƒã‚’ç”Ÿæˆä¸­â€¦</div>

<div id="exportArea" aria-hidden="true">
  <div id="exportInner">
    <div id="exportBanner" class="exportBanner">
      <div class="exportTitlePill">AUDITION PICK â€¢ YOUR TOP 11</div>
    </div>

    <div class="exportBody">
      <div class="exportPyramid" id="exportPyramid"></div>
    </div>

    <div class="exportFooter">created by @12agassi</div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
/* =========================
   â˜… åˆè¨€è‘‰è¨­å®šï¼ˆã“ã“ã ã‘å¤‰ãˆã‚Œã°OKï¼‰
   ========================= */
const PASSPHRASE = "YOU11X";
const PASS_STORAGE_KEY = "oshimaker_pass_ok_v1"; // è§£é™¤æ¸ˆã¿ãƒ•ãƒ©ã‚°
const PASS_TIME_KEY = "oshimaker_pass_ok_time_v1"; // â˜…è§£é™¤æ™‚åˆ»
const PASS_TTL_MS = 60 * 60 * 1000; // â˜…1æ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰

const HEADER_IMAGE_URL = "https://i.imgur.com/nYBRUdd.png";

/* â˜…ç”»åƒURLãŒæœªæŒ‡å®šã§ã‚‚å£Šã‚Œãªã„ãƒ€ãƒŸãƒ¼ */
const FALLBACK_IMG = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

/* å…¬å¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«URLçµ„ã¿ç«‹ã¦ */
function profileUrl(pid){
  if(!pid) return "";
  return "https://produce101.jp/profile/detail/?lang=ja&id=" + encodeURIComponent(pid);
}

/* ====== traineesOnlyï¼ˆç·´ç¿’ç”Ÿï¼‰ ====== */
const traineesOnly = [
  {name:"ã‚¢ãƒ€ãƒ ãƒ»ãƒŠã‚¬ã‚¤(ADAM)", img:"https://i.imgur.com/6QGzvRx.png", pid:"adamnagai"},
  {name:"ä¸­ä¸¸ æ™å¯¿(AJU)", img:"https://i.imgur.com/KiZCKos.png", pid:"nakamaruaju"},
  {name:"ã‚ªãƒ ãƒ»ã‚¹ã‚¢ãƒ³ã‚«ãƒ¯ãƒ¼ãƒ†ãƒ³(AOM)", img:"https://i.imgur.com/dDIFJSc.png", pid:"aomsuungkavathin"},
  {name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ã‚¦ã‚¤(ARCHER)", img:"https://i.imgur.com/5iIerqN.png", pid:"archeruy"},
  {name:"ç¯ ãƒ¶è°· æ­©å¤¢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png", pid:"shinogayaayumu"},

  {name:"å°æ— åƒæ‚Ÿ(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png", pid:"kobayashichisato"},
  {name:"åŠ è—¤ å¤§æ¨¹ (K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png", pid:"katodaiki"},
  {name:"ã‚«ã‚¯ãƒ»ãƒ‰ãƒ³ãƒŸãƒ³(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png", pid:"kwakdongmin"},
  {name:"æœ«å· ç‘›å¤ª(EITA)", img:"https://i.imgur.com/alEjKCP.png", pid:"suekawaeita"},
  {name:"ä¿é‡Œ ç‘›éƒ½(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png", pid:"horieito"},
  {name:"é‡‘ç”° æ „éƒ½(K.EITO)", img:"https://i.imgur.com/tF7i1du.png", pid:"kanedaeito"},
  {name:"æ«»äº• æ¥“çœŸ(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png", pid:"sakuraifuma"},

  {name:"å°ç¬ åŸã‚¸ãƒ¥ã‚¼ãƒƒãƒšæ…§(GIUSEPPE)", img:"https://i.imgur.com/2oKn3Ma.jpeg", pid:"ogasawaragiuseppekei"},
  {name:"å€‰æ©‹ å¾æ§™(GOTEN)", img:"https://i.imgur.com/hlEjYqR.png", pid:"kurahashigoten"},
  {name:"å €å°¾ è–(HIJIRI)", img:"https://i.imgur.com/5Qb5dRJ.png", pid:"horiohijiri"},
  {name:"ç‘æ…¶è¦§ å¤ªéƒ½(HIROTO)", img:"https://i.imgur.com/siOPGIr.png", pid:"zukeranhiroto"},
  {name:"ãƒ¦ãƒ»ãƒ’ãƒ§ãƒ³ã‚¹ãƒ³(HYEONSEUNG)", img:"https://i.imgur.com/lY3lXLj.png", pid:"yoohyeonseung"},
  {name:"å²¡ç”° å½ªå¾(HYUGO)", img:"https://i.imgur.com/zalwc1W.png", pid:"okadahyugo"},
  {name:"æŸ³è°· ä¼Šå†´(ISSA)", img:"https://i.imgur.com/gboCNWu.png", pid:"yanagiyaissa"},
  {name:"ãƒ¦ãƒ³ãƒ»ã‚¸ã‚§ãƒ¨ãƒ³(JAEYONG)", img:"https://i.imgur.com/1yCImxd.png", pid:"yoonjaeyong"},
  {name:"ã‚¸ãƒ¥ã‚¢ãƒ³ãƒ»ã‚¸ã‚§ã‚¤(JAY)", img:"https://i.imgur.com/41jKNZX.png", pid:"chuangjay"},
  {name:"ä¸¸å°¾ å°‹ä¸€éƒ(JINICHIRO)", img:"https://i.imgur.com/83azYjx.png", pid:"maruojinichiro"},
  {name:"æ²³é‚Š æ™Ÿ(JOE)", img:"https://i.imgur.com/DqUS1o6.png", pid:"kawabejoe"},

  {name:"ã‚·ãƒ³ãƒ»ã‚¸ãƒ§ãƒ³ã‚¦ã‚¯(JUNGUK)", img:"https://i.imgur.com/6cwEusK.jpeg", pid:"shinjunguk"},
  {name:"é‡‘å®‰ ç´”æ­£(JUNSEI)", img:"https://i.imgur.com/juPhMDR.png", pid:"kaneyasujunsei"},
  {name:"å®‡é‡ æµ·å¤¢(KAIMU)", img:"https://i.imgur.com/QVliSyD.png", pid:"unokaimu"},
  {name:"å¤šæ¯” å¥è–(KANADE)", img:"https://i.imgur.com/rdSJ6QX.png", pid:"tabikanade"},
  {name:"æ¨ªå±± å¥å¤¢(KANAME)", img:"https://i.imgur.com/0brlEw8.png", pid:"yokoyamakaname"},
  {name:"é–¢ æ•¬æ¬¡éƒ(KEIJIRO)", img:"https://i.imgur.com/PHlkDUt.png", pid:"sekikeijiro"},
  {name:"é«™æ¾ æ•¬ç¥(KEISUKE)", img:"https://i.imgur.com/bs4vfiF.png", pid:"takamatsukeisuke"},
  {name:"å°é‡ æ…¶äºº(KEITO)", img:"https://i.imgur.com/glfmRJE.png", pid:"onokeito"},
  {name:"è¥¿å±± è³¢äºº(KENTO)", img:"https://i.imgur.com/izEXoBY.png", pid:"nishiyamakento"},
  {name:"æ²³åˆ æ™ƒèª (KOSEI)", img:"https://i.imgur.com/E30eGfr.png", pid:"kawaikosei"},
  {name:"ç…§äº• åº·ç¥(KOSUKE)", img:"https://i.imgur.com/oDkwdFn.png", pid:"teruikosuke"},
  {name:"æµ…é¦™ å­å¤ªéƒ(KOTARO)", img:"https://i.imgur.com/7eJxl8o.png", pid:"asakakotaro"},
  {name:"é«™è°· äº¬å¹³(KYOHEI)", img:"https://i.imgur.com/CLU1cPO.png", pid:"takayakyohei"},
  {name:"ç”°ä¸­ è’”(MAKI)", img:"https://i.imgur.com/No6Nybr.png", pid:"tanakamaki"},
  {name:"å±±æ ¹ æ­¦è”µ(MUSASHI)", img:"https://i.imgur.com/Ou2XuDa.png", pid:"yamanemusashi"},
  {name:"åœŸç”° å¤®ä¿®(OSUKE)", img:"https://i.imgur.com/Xs0WjIn.png", pid:"tsuchidaosuke"},
  {name:"å €é‡ è“®(H.REN)", img:"https://i.imgur.com/FQEx0JM.png", pid:"horinoren"},
  {name:"å°æ¸…æ°´ è“®(KO.REN)", img:"https://i.imgur.com/S8Ij9OZ.png", pid:"koshimizuren"},
  {name:"ãƒã‚§ãƒ³ãƒ»ãƒªãƒƒã‚­ãƒ¼(RICKEY)", img:"https://i.imgur.com/DnnZVAT.png", pid:"chenrickey"},

  {name:"ç¥å…ƒ ç†ä¸˜(RIKU)", img:"https://i.imgur.com/jwJ9CLd.png", pid:"kamimotoriku"},
  {name:"é³©å ´ é™¸äºº(H.RIKUTO)", img:"https://i.imgur.com/JdCFbCb.png", pid:"hatobarikuto"},
  {name:"ä»Šæ±Ÿ é™¸æ–—(I.RIKUTO)", img:"https://i.imgur.com/jiZZwJu.png", pid:"imaerikuto"},
  {name:"ç”²æ– é™¸ä¹Ÿ(RIKUYA)", img:"https://i.imgur.com/lfiqB2f.png", pid:"kairikuya"},
  {name:"å¤§ç€¬ å‡œå’Œ(RINTO)", img:"https://i.imgur.com/OT0UHId.png", pid:"ohserinto"},
  {name:"ä¸Šé‡ ç‰å‰(U.RUI)", img:"https://i.imgur.com/36XqMd9.png", pid:"uenorui"},
  {name:"é£¯å¡š äº®è³€(RYOGA)", img:"https://i.imgur.com/ExbaI6W.png", pid:"iizukaryoga"},
  {name:"çŸ³ç”° äº®å¤ª(RYOTA)", img:"https://i.imgur.com/Ctw95jF.png", pid:"ishidaryota"},
  {name:"å²¡æˆ¸ ç«œèŠ½(RYUGA)", img:"https://i.imgur.com/gyPHKjY.png", pid:"okadoryuga"},
  {name:"æ‰å±± ç«œå¸(RYUJI)", img:"https://i.imgur.com/NeB980M.png", pid:"sugiyamaryuji"},
  {name:"é¦™æœˆ èª å¤ª(SEITA)", img:"https://i.imgur.com/def6F6u.png", pid:"katsukiseita"},
  {name:"æ¾¤äº• æ˜Ÿå(SENA)", img:"https://i.imgur.com/Dpzzr9K.png", pid:"sawaisena"},
  {name:"ã‚ªãƒ»ã‚·ãƒ³ãƒ˜ãƒ³(SHINHAENG)", img:"https://i.imgur.com/LH673dA.png", pid:"ohshinhaeng"},
  {name:"å²©åŸ æ…äºŒ(SHINJI)", img:"https://i.imgur.com/h5rDvjC.png", pid:"iwakishinji"},
  {name:"å®®å´ çœŸä½‘(SHINSUKE)", img:"https://i.imgur.com/xJuj9wW.png", pid:"miyazakishinsuke"},
  {name:"è¥¿ï¨‘ æŸŠ(N.SHU)", img:"https://i.imgur.com/OZrHFUX.png", pid:"nishizakishu"},
  {name:"å±±ä¸‹ æŸŠ(Y.SHU)", img:"https://i.imgur.com/642IX8o.png", pid:"yamashitashu"},
  {name:"ãƒ‘ã‚¯ãƒ»ã‚·ãƒ¨ãƒ³(SIYOUNG)", img:"https://i.imgur.com/wSokxJh.png", pid:"parksiyoung"},
  {name:"ä½è—¤ ç¢§ç©º (S.SORA)", img:"https://i.imgur.com/yF4WJJB.png", pid:"satosora"},

  {name:"æ±é‡ è’¼æ±°(SOTA)", img:"https://i.imgur.com/GvLpwfo.png", pid:"tonosota"},
  {name:"è—¤ç‰§ å¤§é›…(F.TAIGA)", img:"https://i.imgur.com/4G2hBRy.png", pid:"fujimakitaiga"},
  {name:"æ¾ç”° å¤ªé›…(M.TAIGA)", img:"https://i.imgur.com/tICsJFs.png", pid:"matsudataiga"},
  {name:"é‡‘å€‰ æ‹“æœª(TAKUMI)", img:"https://i.imgur.com/O3gluG7.png", pid:"kanakuratakumi"},
  {name:"ç†Šéƒ¨ æ‹“æ–—(K.TAKUTO)", img:"https://i.imgur.com/NaQURc7.png", pid:"kumabetakuto"},
  {name:"å®®é‡Œ æ‹“åˆ©(M.TAKUTO)", img:"https://i.imgur.com/5B8NMyF.png", pid:"miyazatotakuto"},
  {name:"å—å¹³ é”çŸ¢(TATSUYA)", img:"https://i.imgur.com/jHnmGTs.png", pid:"minamihiratatsuya"},
  {name:"æ£®äº• è¼(TERU)", img:"https://i.imgur.com/SAo1Rs4.png", pid:"moriiteru"},
  {name:"åŒ—æ— å¤©è™(TETORA)", img:"https://i.imgur.com/2gCwqHF.png", pid:"kitabayashitetora"},
  {name:"è—¤èŠ³ è¾°å¼¥(TOKIYA)", img:"https://i.imgur.com/9prpjvI.png", pid:"fujiyoshitokiya"},
  {name:"å¢—ç”° å€«å¸Œ(TOMOKI)", img:"https://i.imgur.com/4JSh3HD.png", pid:"masudatomoki"},
  {name:"æ¿±ç”° æ°¸é (TOWA)", img:"https://i.imgur.com/Yap9beM.png", pid:"hamadatowa"},
  {name:"ã‚¢ã‚®ãƒŠãƒ«ãƒ‰ãƒ»ãƒˆãƒªã‚¹ã‚¿ãƒ³ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚¹(TRISTAN)", img:"https://i.imgur.com/wyeHbRo.png", pid:"aguinaldotristanjames"},
  {name:"ãƒªãƒ¼ãƒ»ã‚¦ã‚§ã‚¤ã‚¼(WEIZE)", img:"https://i.imgur.com/XNeHaaX.png", pid:"liweize"},
  {name:"ãƒ¨ãƒãƒ³ãƒ»ã‚¨ãƒãƒ‹ãƒ¥ã‚¨ãƒ«(YOHAN)", img:"https://i.imgur.com/RTVMTCA.png", pid:"yohanemmanuel"},
  {name:"çŸ¢ç”° ä½³æš‰(YOSHIKI)", img:"https://i.imgur.com/MZbSVDq.png", pid:"yadayoshiki"},
  {name:"å¾Œè—¤ çµ(YUKI)", img:"https://i.imgur.com/GZTdD57.png", pid:"gotoyuki"},
  {name:"å²¡ç”° ä¾‘ç£¨(YUMA)", img:"https://i.imgur.com/3hhNQLj.png", pid:"okadayuma"},
  {name:"å®‰éƒ¨ çµè˜­(YURA)", img:"https://i.imgur.com/pbC301p.png", pid:"abeyura"},
  {name:"å¤§æ— æ‚ æˆ(O.YUSEI)", img:"https://i.imgur.com/tp1fKqI.png", pid:"obayashiyusei"},
  {name:"ä½é‡ ç”±å¾(S.YUSEI)", img:"https://i.imgur.com/fDql5Tu.png", pid:"sanoyusei"},
  {name:"æ¿å€‰ æ‚ å¤ª(YUTA)", img:"https://i.imgur.com/j6IlxeD.png", pid:"itakurayuta"}
];

/* ====== candidatesï¼ˆç·´ç¿’ç”Ÿå€™è£œï¼‰ ====== */
const candidates = [
  {name:"æœ¬è˜ æ™ƒ(AKIRA)", img:"https://i.imgur.com/p976l8j.jpeg", pid:"honjoakira"},
  {name:"å…å³¶ æ­©å¤¢(K.AYUMU)", img:"https://i.imgur.com/1jtcgbB.png", pid:"kojimaayumu"},
  {name:"å¸‚å· å¤§è¼(I.DAIKI)", img:"https://i.imgur.com/72FqxLz.png", pid:"ichikawadaiki"},
  {name:"å·æ‘ ç€æ–—(HAKUTO)", img:"https://i.imgur.com/ua7RMig.png", pid:"kawamurahakuto"},
  {name:"æ‘æ¾ é¼ç©º(HARUKU)", img:"https://i.imgur.com/3JEtKs6.png", pid:"muramatsuharuku"},
  {name:"é«™åŸ æš–äºº(HARUTO)", img:"https://i.imgur.com/qdXIOpr.png", pid:"takagiharuto"},
  {name:"å¹³å³¶ è¼(H.HIKARU)", img:"https://i.imgur.com/P5gzRZh.png", pid:"hirashimahikaru"},
  {name:"æ«»äº• è¼(S.HIKARU)", img:"https://i.imgur.com/h2fBMUv.png", pid:"sakuraihikaru"},
  {name:"ä½å· å¤ªä¸€(HIROKAZU)", img:"https://i.imgur.com/h2fBMUv.png", pid:"sagawahirokazu"},
  {name:"ã‚¤ãƒ»ãƒ’ãƒ§ãƒ³ã‚¸ã‚§(HYUNJAE)", img:"https://i.imgur.com/wOhvKDu.png", pid:"leehyunjae"},
  {name:"é˜¿éƒ¨ æ¨¹(ITSUKI)", img:"https://i.imgur.com/TaTAc2L.png", pid:"abeitsuki"},
  {name:"ã‚¤ãƒ»ã‚¸ãƒ¥ãƒ³ãƒ•ãƒ³(JOONGHOON)", img:"https://i.imgur.com/4utwyOJ.png", pid:"leejoonghoon"},

  {name:"ãƒªãƒ¥ã‚¦ãƒ»ã‚«ã‚¤ãƒ(KAICHI)", img:"https://i.imgur.com/FGbdGcI.png", pid:"liukaichi"},
  {name:"é»’ï¨‘ è²«æ±°(KANTA)", img:"https://i.imgur.com/j75eoO7.png", pid:"kurosakikanta"},
  {name:"é»„ æ•¬çœ(KEISHIN)", img:"https://i.imgur.com/oE7w4D7.png", pid:"kokeishin"},
  {name:"é‡¼æŒ å‰æˆ(KINARI)", img:"https://i.imgur.com/GWAtiwS.png", pid:"kenmotsukinari"},
  {name:"å°æ¾¤ æ˜‚å¿ƒ(KOSHIN)", img:"https://i.imgur.com/pn0zB7F.png", pid:"ozawakoshin"},
  {name:"é’æ²¼ æ˜‚å²æœ—(KOSHIRO)", img:"https://i.imgur.com/MDhTcs8.png", pid:"aonumakoshiro"},
  {name:"å°æ— å»£(KOU)", img:"https://i.imgur.com/RAoUIhC.png", pid:"kobayashikou"},
  {name:"æ£® æ˜è‚²(MEI)", img:"https://i.imgur.com/eR0BZVs.png", pid:"morimei"},
  {name:"ãƒã‚¤ã‚±ãƒ« ãƒŸãƒ³ãƒ»ãƒã‚«ãƒ•ãƒª(MICHAEL MINH)", img:"https://i.imgur.com/6S8BWAA.png", pid:"michaelminhmccaffrey"},
  {name:"ãƒ‘ãƒˆãƒªãƒƒã‚¯ ãƒ•ã‚¡ãƒ³ãƒ»ãƒ¬(PATRICK)", img:"https://i.imgur.com/YRvJQYc.png", pid:"patrickphanle"},
  {name:"ç¬ åŸ è“®(KA.REN)", img:"https://i.imgur.com/ZLgNm7o.png", pid:"kasahararen"},
  {name:"æ±Ÿå£ è“®ç¿”(E.RENTO)", img:"https://i.imgur.com/ewXd8NH.png", pid:"eguchirento"},
  {name:"å°æ— è“®ç¿”(K.RENTO)", img:"https://i.imgur.com/t2NbxIU.png", pid:"kobayashirento"},
  {name:"è½åˆ åˆ©æ¸©(RIO)", img:"https://i.imgur.com/HdTZUdu.png", pid:"ochiairio"},
  {name:"æ°´ä¸Š ç‰å‰(M.RUI)", img:"https://i.imgur.com/DiUA9bw.png", pid:"mizugamirui"},
  {name:"å°è°·å†… ç‘ å˜‰(RUKA)", img:"https://i.imgur.com/V2XnsQ6.png", pid:"koyauchiruka"},
  {name:"é½Šè—¤ æƒº(SEI)", img:"https://i.imgur.com/9HIRvNd.png", pid:"saitosei"},
  {name:"è—¤æœ¬ çœŸæˆ(SHINSEI)", img:"https://i.imgur.com/qTooOuS.png", pid:"fujimotoshinsei"},
  {name:"é£¯ç”° æŸŠé¦¬(SHUMA)", img:"https://i.imgur.com/awBBn6j.png", pid:"iidashuma"},
  {name:"æ¾ç”° é¢¯å¾(SOGO)", img:"https://i.imgur.com/Y1MQK3k.png", pid:"matsudasogo"},
  {name:"é«™æ©‹ ç©ºè‰¯(T.SORA)", img:"https://i.imgur.com/czFpgjm.png", pid:"takahashisora"},
  {name:"è¥¿ç”° é¢¯æ¢“(SOSHI)", img:"https://i.imgur.com/51RMIB6.png", pid:"nishidasoshi"},
  {name:"å²¡æœ¬ æ‹“å£«(O.TAKUTO)", img:"https://i.imgur.com/TGP6sbe.png", pid:"okamototakuto"},
  {name:"å¤§æ¾¤ ä½‘å†´(YUGO)", img:"https://i.imgur.com/5Gg1E1M.png", pid:"osawayugo"},
  {name:"è—¤äº• é›„è–(F.YUSEI)", img:"https://i.imgur.com/prsNOtG.png", pid:"fujiiyusei"},
  {name:"å²¡æœ¬ ä½‘æ–—(YUTO)", img:"https://i.imgur.com/lzv8Vu5.png", pid:"okamotoyuto"}
];

/* trainees = çµåˆ */
const trainees = traineesOnly.concat(candidates);
const TRAINEES_COUNT = traineesOnly.length;

const rowSizes = [1,2,3,5];
const STORAGE_KEY = "oshimaker_selected_final_v5";

let reorderMode = false;
let selected = loadSelected();

/* è¡¨ç¤ºåˆ‡æ›¿çŠ¶æ…‹ï¼ˆåˆæœŸã¯ç·´ç¿’ç”Ÿè¡¨ç¤ºï¼‰ */
let showingCandidates = false;

/* ãƒãƒŠãƒ¼ç”»åƒåæ˜  */
(function setupBanners(){
  const banner = document.getElementById("banner");
  const exportBanner = document.getElementById("exportBanner");
  if(HEADER_IMAGE_URL){
    banner.classList.add("hasImage");
    banner.style.backgroundImage = "url('" + HEADER_IMAGE_URL + "')";
    exportBanner.style.backgroundImage = "url('" + HEADER_IMAGE_URL + "')";
  }
})();

function displayName(full){
  return (full || "").replace(/\s*\([^)]*\)\s*/g, "").trim();
}
function alphaPart(full){
  const m = (full||"").match(/\(([^)]*)\)/);
  return m ? "(" + m[1] + ")" : "";
}

/* ç·´ç¿’ç”Ÿ/å€™è£œ åˆ‡æ›¿ï¼ˆã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚‚ç¶­æŒï¼‰ */
function toggleCandidates(e){
  if(e && e.preventDefault) e.preventDefault();

  var wrap = document.getElementById("membersWrap");
  var listScroll = wrap ? wrap.scrollTop : 0;
  var winY = window.scrollY;

  showingCandidates = !showingCandidates;

  var btn = document.getElementById("toggleListBtn");
  btn.textContent = showingCandidates ? "ç·´ç¿’ç”Ÿ" : "ç·´ç¿’ç”Ÿå€™è£œ";

  drawMembers();

  requestAnimationFrame(function(){
    if(wrap) wrap.scrollTop = listScroll;
    window.scrollTo(0, winY);
  });
}

/* å¹…ãƒ»é«˜ã•ã©ã£ã¡ã‚‚è¦‹ã¦ã€Œ11å€‹ãŒçµ¶å¯¾ã«åˆ‡ã‚Œãªã„ã€ã‚ˆã†ã«slot/gapã‚’æ±ºå®š */
function fitPyramidToViewport(){
  var headerEl = document.querySelector("header");
  var headerH = headerEl ? headerEl.getBoundingClientRect().height : 60;

  var card = document.getElementById("pyramidCard");
  var wrap = document.getElementById("pyramidWrap");
  if(!card || !wrap) return;

  var cardRect = card.getBoundingClientRect();

  var availableW = cardRect.width - 28;
  var availableH = window.innerHeight - headerH - 12 - 12;

  var bannerH = 110;
  var actionsH = 72;
  var wrapPad = 12+8+10;

  var nameH = 16;
  var badgeOut = 22;

  var maxRow = 5;

  var slot = 92;
  var gap  = 18;

  function needHeight(s,g){
    return bannerH + actionsH + wrapPad + (s*4) + (g*3) + (nameH*4) + badgeOut;
  }
  function needSlotByWidth(g){
    return Math.floor((availableW - g*(maxRow-1)) / maxRow);
  }

  slot = Math.min(slot, needSlotByWidth(gap));

  while((needHeight(slot,gap) > availableH || slot*maxRow + gap*(maxRow-1) > availableW) && slot > 58){
    slot -= 2;
    gap  -= 1;
    if(gap < 10) gap = 10;
    slot = Math.min(slot, needSlotByWidth(gap));
  }

  document.documentElement.style.setProperty("--slot", slot + "px");
  document.documentElement.style.setProperty("--gap", gap + "px");
}

/* =========================
   2åˆ—ã‚«ãƒ¼ãƒ‰æç”» + profile
   ========================= */
function drawMembers(){
  var qEl = document.getElementById("search");
  var q = (qEl ? qEl.value : "").trim().toLowerCase();
  var membersEl = document.getElementById("members");
  membersEl.innerHTML = "";

  var start = showingCandidates ? TRAINEES_COUNT : 0;
  var end   = showingCandidates ? trainees.length : TRAINEES_COUNT;

  for(var i=start; i<end; i++){
    var m = trainees[i];
    var hay = (m.name || "").toLowerCase();
    if(q && hay.indexOf(q) === -1) continue;

    var card = document.createElement("div");
    card.className = "memberCard";
    if(selected.indexOf(i) !== -1) card.classList.add("selected");

    var pidUrl = profileUrl(m.pid);

    card.innerHTML = `
      ${pidUrl ? `<a class="profileLink" href="${pidUrl}" target="_blank" rel="noopener noreferrer">profile</a>` : ""}
      <div class="memberPhoto"><img src="${m.img || FALLBACK_IMG}" alt=""></div>
      <div class="memberInfo">
        <div class="memberName">${displayName(m.name)}</div>
        <div class="memberSub">${alphaPart(m.name)}</div>
      </div>
    `;

    /* ã‚«ãƒ¼ãƒ‰æœ¬ä½“ã‚¿ãƒƒãƒ—ã§è¿½åŠ  */
    card.addEventListener("click", (function(idx){ return function(){ add(idx); }; })(i));

    /* profileæŠ¼ä¸‹ã§è¿½åŠ ãŒç™ºç«ã—ãªã„ã‚ˆã†ã«æ­¢ã‚ã‚‹ */
    var link = card.querySelector(".profileLink");
    if(link){
      link.addEventListener("click", function(ev){
        ev.stopPropagation();
      });
    }

    membersEl.appendChild(card);
  }
}

function add(i){
  if(selected.length >= 11){ alert("11äººã¾ã§ï¼"); return; }
  if(selected.indexOf(i) !== -1) return;

  selected.push(i);
  saveSelected();

  drawMembers();
  drawPyramid();
  drawExportPyramid();
  fitPyramidToViewport();
}

function undo(){
  selected.pop();
  saveSelected();
  drawMembers();
  drawPyramid();
  drawExportPyramid();
  fitPyramidToViewport();
}

function resetAll(){
  selected = [];
  saveSelected();
  drawMembers();
  drawPyramid();
  drawExportPyramid();
  fitPyramidToViewport();
}

function saveSelected(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
}
function loadSelected(){
  try{
    var raw = localStorage.getItem(STORAGE_KEY);
    var arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr.filter(function(n){ return Number.isInteger(n); }) : [];
  }catch(e){ return []; }
}

function toggleReorder(){
  reorderMode = !reorderMode;
  document.body.classList.toggle("reorder-on", reorderMode);
  document.getElementById("reorderBtn").textContent = "ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼š" + (reorderMode ? "ON" : "OFF");
}

function swap(posA, posB){
  if(posA < 0 || posB < 0) return;
  if(posA >= selected.length || posB >= selected.length) return;
  var tmp = selected[posA];
  selected[posA] = selected[posB];
  selected[posB] = tmp;
  saveSelected();
  drawMembers();
  drawPyramid();
  drawExportPyramid();
}

function moveLeft(pos){ swap(pos, pos-1); }
function moveRight(pos){ swap(pos, pos+1); }

function drawPyramid(){
  var p = document.getElementById("pyramid");
  p.innerHTML = "";
  var idx = 0;

  rowSizes.forEach(function(size){
    var row = document.createElement("div");
    row.className = "row";

    for(var k=0;k<size;k++){
      var slot = document.createElement("div");
      if(idx < selected.length){
        var m = trainees[selected[idx]];
        slot.className = "slot";
        slot.innerHTML = `
          <div class="avatar">
            <img src="${m.img}" alt="">
            <div class="rank">${idx+1}</div>
          </div>
          <div class="name">${displayName(m.name)}</div>
          <div class="reorder">
            <button onclick="moveLeft(${idx})" aria-label="left">â†</button>
            <button onclick="moveRight(${idx})" aria-label="right">â†’</button>
          </div>
        `;
      }else{
        slot.className = "slot empty";
        slot.innerHTML = `<div class="avatar">+</div>`;
      }
      row.appendChild(slot);
      idx++;
    }
    p.appendChild(row);
  });
}

function drawExportPyramid(){
  var p = document.getElementById("exportPyramid");
  p.innerHTML = "";
  var idx = 0;

  rowSizes.forEach(function(size){
    var row = document.createElement("div");
    row.className = "exportRow";

    for(var k=0;k<size;k++){
      var slot = document.createElement("div");
      if(idx < selected.length){
        var m = trainees[selected[idx]];
        slot.className = "exportSlot";
        slot.innerHTML = `
          <div class="exportAvatar">
            <div class="exportPhoto" style="background-image:url('${m.img}')"></div>
            <div class="exportRank">${idx+1}</div>
          </div>
          <div class="exportName">${displayName(m.name)}</div>
        `;
      }else{
        slot.className = "exportSlot exportEmpty";
        slot.innerHTML = `<div class="exportAvatar">+</div>`;
      }
      row.appendChild(slot);
      idx++;
    }
    p.appendChild(row);
  });
}

async function saveImage(){

  alert("ã€ãŠé¡˜ã„ã€‘\nSNSã«æŠ•ç¨¿ã™ã‚‹éš›ã¯\n#æ—¥ãƒ—æ–°ä¸–ç•Œæ¨ã—ãƒ¡ãƒ¼ã‚«ãƒ¼\nã®ã‚¿ã‚°ã‚’ä»˜ã‘ã¦æŠ•ç¨¿ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ğŸ™‡ğŸ»â€â™€ï¸");

  if(typeof html2canvas === "undefined"){
    alert("ç”»åƒä¿å­˜ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
    return;
  }

  drawExportPyramid();
  var toast = document.getElementById("toast");
  toast.style.display = "block";

  try{
    var target = document.getElementById("exportInner");
    var canvas = await html2canvas(target, {
      backgroundColor:"#ffffff",
      useCORS:true,
      allowTaint:false,
      scale: 4
    });

    var link = document.createElement("a");
    link.download = "oshimaker_1004x1040.png";
    link.href = canvas.toDataURL("image/png");
    link.click();
  }catch(e){
    alert("ç”»åƒç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚ç”»åƒURLå´ã®åˆ¶é™ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚");
  }finally{
    toast.style.display = "none";
  }
}

/* =========================
   â˜… åˆè¨€è‘‰ãƒ­ãƒƒã‚¯åˆ¶å¾¡
   ========================= */
function norm(s){
  return (s || "").trim();
}
function isUnlocked(){
  try{
    const ok = localStorage.getItem(PASS_STORAGE_KEY) === "1";
    const t  = parseInt(localStorage.getItem(PASS_TIME_KEY) || "0", 10);
    if(!ok || !t) return false;

    // 1æ™‚é–“ä»¥å†…ãªã‚‰OK
    if(Date.now() - t < PASS_TTL_MS) return true;

    // æœŸé™åˆ‡ã‚Œ â†’ ãƒ­ãƒƒã‚¯ã«æˆ»ã™
    localStorage.removeItem(PASS_STORAGE_KEY);
    localStorage.removeItem(PASS_TIME_KEY);
    return false;
  }catch(e){
    return false;
  }
}
function setUnlocked(){
  try{
    localStorage.setItem(PASS_STORAGE_KEY, "1");
    localStorage.setItem(PASS_TIME_KEY, Date.now().toString());
  }catch(e){}
}
function showLock(){
  document.body.classList.add("locked");
  document.getElementById("lockOverlay").classList.add("show");
  document.getElementById("passErr").classList.remove("show");
  var inp = document.getElementById("passInput");
  inp.value = "";
  setTimeout(function(){ inp.focus(); }, 120);
}
function hideLockWithFx(){
  // ãƒ­ãƒƒã‚¯ç”»é¢ã‚’é–‰ã˜ã‚‹â†’æ¼”å‡ºâ†’æœ¬ä½“ãµã‚ã£ã¨è¡¨ç¤º
  document.getElementById("lockOverlay").classList.remove("show");

  var fx = document.getElementById("unlockFx");
  fx.classList.add("show");

  // 900msã‚¢ãƒ‹ãƒ¡ï¼‹å°‘ã—ä½™è£•
  setTimeout(function(){
    fx.classList.remove("show");
    document.body.classList.remove("locked");
  }, 2050);
}
function tryUnlock(){
  var val = norm(document.getElementById("passInput").value);
  var ok = (val === PASSPHRASE);

  if(ok){
    setUnlocked();
    hideLockWithFx();
  }else{
    var err = document.getElementById("passErr");
    err.classList.add("show");
    // ã¡ã‚‡ã„æºã‚Œæ„Ÿï¼ˆç°¡æ˜“ï¼‰
    var card = document.querySelector(".lockCard");
    if(card){
      card.animate(
        [
          {transform:"translateX(0)"},
          {transform:"translateX(-6px)"},
          {transform:"translateX(6px)"},
          {transform:"translateX(-4px)"},
          {transform:"translateX(4px)"},
          {transform:"translateX(0)"}
        ],
        {duration: 260, easing:"ease-out"}
      );
    }
  }
}

/* =========================
   åˆæœŸæç”»
   ========================= */
drawMembers();
drawPyramid();
drawExportPyramid();
fitPyramidToViewport();
window.addEventListener("resize", function(){ fitPyramidToViewport(); });

/* ãƒ­ãƒƒã‚¯åˆæœŸåŒ– */
(function initLock(){
  var btn = document.getElementById("unlockBtn");
  var inp = document.getElementById("passInput");

  btn.addEventListener("click", tryUnlock);
  inp.addEventListener("keydown", function(e){
    if(e.key === "Enter") tryUnlock();
  });

  // æœªè§£é™¤ãªã‚‰ãƒ­ãƒƒã‚¯è¡¨ç¤º
  if(!isUnlocked()){
    showLock();
  }else{
    // è§£é™¤æ¸ˆã¿ãªã‚‰ãƒ­ãƒƒã‚¯çŠ¶æ…‹ã«ã—ãªã„
    document.body.classList.remove("locked");
    document.getElementById("lockOverlay").classList.remove("show");
  }
})();
</script>
</body>
</html>
